<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Doodle World</title>
    <meta name="description" content="">
    <meta name="author" content="qingyuanxingsi">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
    <script src="../theme/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.1.1/css/bootstrap.no-icons.min.css" rel="stylesheet">
    <link href="../theme/local.css" rel="stylesheet">
    <link href="../theme/pygments.css" rel="stylesheet">
    <link href="../theme/font-awesome.css" rel="stylesheet">
    <link href='http://fonts.googleapis.com/css?family=Gudea:400,400italic|Alegreya+SC' rel='stylesheet' type='text/css'>
</head>

<body>
<header class="blog-header">
  <div class="container">
    <div class="row-fluid">
      <div class="span9">
	<a href=".." class="brand">Doodle World</a>
      </div>

      <div class="span3" id="blog-nav">
	<ul class="nav nav-pills pull-right">
            <li><a href="../pages/about.html">About</a></li>
	    <li >
	      <a href="../category/distributed-system.html ">Distributed System</a>
	    <li >
	      <a href="../category/life.html ">Life</a>
	    <li >
	      <a href="../category/machine-learning.html ">Machine Learning</a>
	    <li >
	      <a href="../category/viewpoint.html ">Viewpoint</a>
	</ul>
      </div>
    </div> <!-- End of fluid row-->
  </div>   <!-- End of Container-->
</header>
    
<div class="container">
    <div class="content">
    <div class="row-fluid">

        <div class="span10">
        

        

    <div class='row-fluid''>
        <div class="article-title span9">
            <a href="../fen-bu-shi-ji-suan-xi-lie-iyarnji-chu-ku-chu-tan.html"><h1>分布式计算系列(I):Yarn基础库初探</h1></a>
        </div>
    </div>
    <div class="row-fluid">
      <div class="span2">
<p>六 22 三月 2014 </p>

<p style="text-align: left;">
Filed under <a href="../category/distributed-system.html">Distributed System</a>
</p>
<p style="text-align: left;">
 
    Tags <a href="../tag/rpc.html">RPC</a> <a href="../tag/yarn.html">YARN</a> <a href="../tag/hadoop.html">Hadoop</a> <a href="../tag/state-machine.html">State Machine</a> <a href="../tag/designing-patterns.html">Designing Patterns</a> <a href="../tag/reactor-pattern.html">Reactor Pattern</a> </p>
<p>
</p>
      </div>
      <div class="article-content span8">
	<h1>PREFACE</h1>
<hr>
<p>在上一篇<a href="http://www.qingyuanxingsi.com/fen-bu-shi-ji-suan-yu-cun-chu-xi-lie-xu-zhang-chu-ru-men-jing.html">分布式计算与存储系列(序章):初入门径</a>中,我们主要介绍了分布式存储的一些基础知识,在本系列中,我们会结合论文以及源码对分布式计算的基本理论以及一些应用系统进行研究，以期对分布式系统有一个更为深入的了解。本系列的前若干篇均以研究Yarn为主,主要参考<a href="http://book.douban.com/subject/25774649/">Hadoop技术内幕:深入解析YARN架构设计与实现原理</a>一书的整体架构,但是个人对这本书不是特别满意，讲述的还是有点浅,很多问题只是浅尝则止而已。(真正想<code>深入</code>了解YARN的不建议购买本书，如若只是想粗略的了解一下YARN的工作流程的童鞋倒是可以入手一本滴。)因此，本系列仅会采用其大体框架，在其大体框架下，对YARN设计的其他知识和设计模式等也会有进一步更为深入的介绍。好吧，闲话就不多说了,我们开始正式讨论。</p>
<p>本文的主要目的是介绍一下YARN中用到的基础库,它们是YARN其他模块得以建立的基石,其重要性自然不言而喻。我们先从其RPC库说起。</p>
<h1>The Secret of RPC</h1>
<hr>
<p>当前存在非常多的开源 RPC 框架,比较有名的有 Thrift、Protocol Buffers 和 Avro。同Hadoop RPC一样,它们均由两部分组成:对象序列化和远程过程调用(Protocol Buflers官方仅提供了序列化实现,未提供远程调用相关实现,但三方 RPC 库非常多 )。相比于Hadoop RPC,它们有以下几个特点:</p>
<ul>
<li><strong>跨语言特性</strong>。对于 Hadoop RPC而言,由于Hadoop采用 Java 语言编写,因而其RPC客户端和服务器端仅支持Java语言;但对于更通用的 RPC框架,如Thrift或者Protocol Buffers等,其客户端和服务器端可采用任何语言编写,如Java、C++、Python等,这给用户编程带来极大方便。</li>
<li><strong>引入IDL</strong>。开源RPC框架均提供了一套接口描述语言(Interface Description Language,IDL),它提供一套通用的数据类型,并以这些数据类型来定义更为复杂的数据类型和对外服务接口。一旦用户按照IDL定义的语法编写完接口文件后,可根据实际应用需要生成特定编程语言(如 Java、C++、Python 等)的客户端和服务器端代码。</li>
<li><strong>协议兼容性</strong>。开源RPC框架在设计上均考虑到了协议兼容性问题,即当协议格式发生改变时,比如某个类需要添加或者删除一个成员变量(字段)后,旧版本代码仍然能识别新格式的数据,也就是说,具有向后兼容性。</li>
</ul>
<p>随着Hadoop版本的不断演化,研发人员发现Hadoop RPC在跨语言支持和协议兼容性两个方面存在不足,具体表现为:</p>
<ul>
<li>从长远发展看,Hadoop RPC应允许某些协议的客户端或者服务器端采用其他语言实现,比如用户希望直接使用C/C++语言读写HDFS中的文件,这就需要有C/C++语言的HDFS客户端。</li>
<li>当前 Hadoop 版本较多,而不同版本之间不能通信,比如0.20.2版本的JobTracker不能与0.21.0版本中的TaskTracker通信,如果用户企图这样做,会抛出<em>VersionMismatch</em>异常。</li>
</ul>
<p>为了解决以上几个问题,Hadoop YARN将RPC中的序列化部分剥离开,以便将现有的开源RPC框架集成进来。Hadoop目前集成了Protocol Buffer以及Apache Avro的序列化部分,而函数调用调用机制仍采用Hadoop自带的,其中RPC采用Protocol Buffer,而Apache Avro则用于日志系统。以下对这两种序列化机制进行一个简要的介绍:</p>
<h2>持久化框架</h2>
<h3>Protocol Buffer<sup id="sf-fen-bu-shi-ji-suan-xi-lie-iyarnji-chu-ku-chu-tan-1-back"><a href="#sf-fen-bu-shi-ji-suan-xi-lie-iyarnji-chu-ku-chu-tan-1" class="simple-footnote" title="本部分参考https://developers.google.com/protocol-buffers/docs/javatutorial">1</a></sup></h3>
<p>Protocol Buffers 是一种轻便高效的结构化数据存储格式,可以用于结构化数据序列化/反序列化。它很适合做数据存储或RPC的数据交换格式,常用作通信协议、数据存储等领域的与语言无关、平台无关、可扩展的序列化结构数据格式。目前支持C++、Java、Python三种语言。在
Google 内部,几乎所有的RPC协议和文件格式都是采用Protocol Buffers。</p>
<p>相比于常见的XML格式,Protocol Buffers官方网站这样描述它的优点:</p>
<ul>
<li>平台无关、语言无关;</li>
<li>高性能,解析速度是 XML 的 20 ~ 100 倍;</li>
<li>体积小,文件大小仅是 XML 的 1/10 ~ 1/3;</li>
<li>使用简单;</li>
<li>兼容性好。</li>
</ul>
<p>通常编写一个 Protocol Buffers 应用需要以下三步:</p>
<ul>
<li>定义报文格式(.proto文件)</li>
<li>使用Protocol Buffer Compiler编译生成JAVA类</li>
<li>使用Protocol Buffer API读写报文</li>
</ul>
<h4>定义报文格式</h4>
<p>我们首先定义消息格式文件addressbook.proto,以下定义了一个人的通讯录的基本信息:</p>
<div class="highlight"><pre><span class="n">package</span> <span class="n">tutorial</span><span class="p">;</span>

<span class="n">option</span> <span class="n">java_package</span> <span class="o">=</span> <span class="s">"com.qingyuanxingsi.tutorial"</span><span class="p">;</span>
<span class="n">option</span> <span class="n">java_outer_classname</span> <span class="o">=</span> <span class="s">"AddressBookProtos"</span><span class="p">;</span>

<span class="n">message</span> <span class="n">Person</span> <span class="p">{</span>
    <span class="n">required</span> <span class="n">string</span> <span class="n">name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">required</span> <span class="n">int32</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">optional</span> <span class="n">string</span> <span class="n">email</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

    <span class="k">enum</span> <span class="n">PhoneType</span> <span class="p">{</span>
        <span class="n">MOBILE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">HOME</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">WORK</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">message</span> <span class="n">PhoneNumber</span> <span class="p">{</span>
        <span class="n">required</span> <span class="n">string</span> <span class="n">number</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">optional</span> <span class="n">PhoneType</span> <span class="n">type</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">[</span><span class="k">default</span> <span class="o">=</span> <span class="n">HOME</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="n">repeated</span> <span class="n">PhoneNumber</span> <span class="n">phone</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">message</span> <span class="n">AddressBook</span> <span class="p">{</span>
    <span class="n">repeated</span> <span class="n">Person</span> <span class="n">person</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>.proto文件开头包含一个包声明,以避免不同Project之间的命名冲突。Java中，package名即被用作Java包名,除非通过<code>java_package</code>另外显式指定表明。以上我们制定生成的包名为<code>com.qingyuanxingsi.tutorial</code>.<code>java_outer_classname</code>则指定了类名，我们生成的所有类均会被放在这个文件中。如果未显式制定，则会将文件名自动转化成Camel形式的类名。如,<code>my_proto.proto</code>默认情况下会生成<code>MyProto</code>作为其类名。</p>
<p>接下来则是报文定义。一个报文即是一系列带有类型信息的Field的集合。很多简单数据类型可被用作Field Type,包括bool, int32, float, double, and string. 当然，你也可以自定义类型作为Field Type.在上述例子中,Person报文就包含PhoneNumber报文,AddressBook报文则包括Person报文。另外,报文可被嵌套定义,如PhoneNumber就定义在Person报文中。如果你想让你的某个Field具有一个或多个预定义的值,你可以使用枚举类型，如上述，我们想让电话号码类型取MOBILE, HOME, or WORK中的值。每个字段后的<code>=？</code>标记为每个Field分配了唯一的TAG,以用于二进制编码。</p>
<p><code>required</code>关键字指定该Field必须被赋值，否则报文将会被视为<code>uninitialized</code>.编译此类报文则会抛出<em>RuntimeException</em>异常,除此之外,它与optional field基本相同。<code>optional</code>关键字则表明该Field可被设置，也可不设置。如果未设置,则会使用默认值。对于简单数据类型，我们可以定义我们自己的默认值,否则则会使用系统默认值。对于嵌套报文,默认值则通常会是报文的默认实例或者原型,其中每一个Field均未被设置。repeated则表明该字段可以重复任何多次。</p>
<h4>编译生成JAVA类</h4>
<p>使用以下命令即可生成相应的JAVA类:</p>
<div class="highlight"><pre><span class="n">protoc</span> <span class="o">-</span><span class="n">I</span><span class="o">=</span><span class="err">$</span><span class="n">SRC_DIR</span> <span class="o">--</span><span class="n">java_out</span><span class="o">=</span><span class="err">$</span><span class="n">DST_DIR</span> <span class="err">$</span><span class="n">SRC_DIR</span><span class="o">/</span><span class="n">addressbook</span><span class="p">.</span><span class="n">proto</span>
</pre></div>


<p>生成的类的结构如下图所示(此处不再给出源码):</p>
<p><img alt="AddressBook Struture" src="http://i1302.photobucket.com/albums/ag136/qingyuanxingsi/blog/addressBook_zps34178bad.png"></p>
<h4>使用Protocol Buffer API读写报文</h4>
<p>如上图所示,我们可以看到一个<code>AddressBookProtos.java</code>类,其中则嵌套了多个类,每个类均有.proto中定义的message生成。每个类都有对应的一个<code>Builder</code>类,可以用于构造类实例。</p>
<p>报文类以及Builder类对于报文的每个Field均提供了访问器。值得注意的是,报文类仅提供了getters,而Builder类既有getters,又有setters.以下给出Person类的一个实例:</p>
<div class="highlight"><pre><span class="c1">// required string name = 1;</span>
<span class="n">public</span> <span class="n">boolean</span> <span class="n">hasName</span><span class="p">();</span>
<span class="n">public</span> <span class="n">String</span> <span class="n">getName</span><span class="p">();</span>

<span class="c1">// required int32 id = 2;</span>
<span class="n">public</span> <span class="n">boolean</span> <span class="n">hasId</span><span class="p">();</span>
<span class="n">public</span> <span class="k">int</span> <span class="n">getId</span><span class="p">();</span>

<span class="c1">// optional string email = 3;</span>
<span class="n">public</span> <span class="n">boolean</span> <span class="n">hasEmail</span><span class="p">();</span>
<span class="n">public</span> <span class="n">String</span> <span class="n">getEmail</span><span class="p">();</span>

<span class="c1">// repeated .tutorial.Person.PhoneNumber phone = 4;</span>
<span class="n">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">PhoneNumber</span><span class="o">&gt;</span> <span class="n">getPhoneList</span><span class="p">();</span>
<span class="n">public</span> <span class="k">int</span> <span class="n">getPhoneCount</span><span class="p">();</span>
<span class="n">public</span> <span class="n">PhoneNumber</span> <span class="n">getPhone</span><span class="p">(</span><span class="k">int</span> <span class="n">index</span><span class="p">);</span>
</pre></div>


<p>而与其对应的Builder类则getters和setters都有:</p>
<div class="highlight"><pre><span class="c1">// required string name = 1;</span>
<span class="n">public</span> <span class="n">boolean</span> <span class="n">hasName</span><span class="p">();</span>
<span class="n">public</span> <span class="n">java</span><span class="p">.</span><span class="n">lang</span><span class="p">.</span><span class="n">String</span> <span class="n">getName</span><span class="p">();</span>
<span class="n">public</span> <span class="n">Builder</span> <span class="n">setName</span><span class="p">(</span><span class="n">String</span> <span class="n">value</span><span class="p">);</span>
<span class="n">public</span> <span class="n">Builder</span> <span class="n">clearName</span><span class="p">();</span>

<span class="c1">// required int32 id = 2;</span>
<span class="n">public</span> <span class="n">boolean</span> <span class="n">hasId</span><span class="p">();</span>
<span class="n">public</span> <span class="k">int</span> <span class="n">getId</span><span class="p">();</span>
<span class="n">public</span> <span class="n">Builder</span> <span class="n">setId</span><span class="p">(</span><span class="k">int</span> <span class="n">value</span><span class="p">);</span>
<span class="n">public</span> <span class="n">Builder</span> <span class="n">clearId</span><span class="p">();</span>

<span class="c1">// optional string email = 3;</span>
<span class="n">public</span> <span class="n">boolean</span> <span class="n">hasEmail</span><span class="p">();</span>
<span class="n">public</span> <span class="n">String</span> <span class="n">getEmail</span><span class="p">();</span>
<span class="n">public</span> <span class="n">Builder</span> <span class="n">setEmail</span><span class="p">(</span><span class="n">String</span> <span class="n">value</span><span class="p">);</span>
<span class="n">public</span> <span class="n">Builder</span> <span class="n">clearEmail</span><span class="p">();</span>

<span class="c1">// repeated .tutorial.Person.PhoneNumber phone = 4;</span>
<span class="n">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">PhoneNumber</span><span class="o">&gt;</span> <span class="n">getPhoneList</span><span class="p">();</span>
<span class="n">public</span> <span class="k">int</span> <span class="n">getPhoneCount</span><span class="p">();</span>
<span class="n">public</span> <span class="n">PhoneNumber</span> <span class="n">getPhone</span><span class="p">(</span><span class="k">int</span> <span class="n">index</span><span class="p">);</span>
<span class="n">public</span> <span class="n">Builder</span> <span class="n">setPhone</span><span class="p">(</span><span class="k">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">PhoneNumber</span> <span class="n">value</span><span class="p">);</span>
<span class="n">public</span> <span class="n">Builder</span> <span class="n">addPhone</span><span class="p">(</span><span class="n">PhoneNumber</span> <span class="n">value</span><span class="p">);</span>
<span class="n">public</span> <span class="n">Builder</span> <span class="n">addAllPhone</span><span class="p">(</span><span class="n">Iterable</span><span class="o">&lt;</span><span class="n">PhoneNumber</span><span class="o">&gt;</span> <span class="n">value</span><span class="p">);</span>
<span class="n">public</span> <span class="n">Builder</span> <span class="n">clearPhone</span><span class="p">();</span>
</pre></div>


<p>由Protocol Buffer Compiler编译生成的message类均是不可变的。Message实例一旦生成，就不能更改。为了构造一个message，我们首先构造一个builder,将Field设置成你想要的值,然后调用builder的build()方法。以下代码用于构造一个Person实例:</p>
<div class="highlight"><pre><span class="n">Person</span> <span class="n">john</span> <span class="o">=</span>
    <span class="n">Person</span><span class="p">.</span><span class="n">newBuilder</span><span class="p">()</span>
    <span class="p">.</span><span class="n">setId</span><span class="p">(</span><span class="mi">1234</span><span class="p">)</span>
    <span class="p">.</span><span class="n">setName</span><span class="p">(</span><span class="s">"John Doe"</span><span class="p">)</span>
    <span class="p">.</span><span class="n">setEmail</span><span class="p">(</span><span class="s">"jdoe@example.com"</span><span class="p">)</span>
    <span class="p">.</span><span class="n">addPhone</span><span class="p">(</span>
    <span class="n">Person</span><span class="p">.</span><span class="n">PhoneNumber</span><span class="p">.</span><span class="n">newBuilder</span><span class="p">()</span>
    <span class="p">.</span><span class="n">setNumber</span><span class="p">(</span><span class="s">"555-4321"</span><span class="p">)</span>
    <span class="p">.</span><span class="n">setType</span><span class="p">(</span><span class="n">Person</span><span class="p">.</span><span class="n">PhoneType</span><span class="p">.</span><span class="n">HOME</span><span class="p">))</span>
<span class="p">.</span><span class="n">build</span><span class="p">();</span>
</pre></div>


<p>最后,每个Protocol Buffer类军定义了读写报文的方法,如下所示:</p>
<ul>
<li>byte[] toByteArray();持久化message对象并返回包含一字节数组。</li>
<li>static Person parseFrom(byte[] data);通过给定字节数组解析构造报文实例。</li>
<li>void writeTo(OutputStream output);将报文持久化到OutputStream中.</li>
<li>static Person parseFrom(InputStream input);解析InputStream并构造报文实例.</li>
</ul>
<p>至此,我们给出一个报文读写实例,它用于将报文持久化到文件中然后从文件中解析构造得到原始报文:</p>
<div class="highlight"><pre><span class="n">package</span> <span class="n">org</span><span class="p">.</span><span class="n">qingyuanxingsi</span><span class="p">.</span><span class="n">protoc</span><span class="p">;</span>

<span class="n">import</span> <span class="n">java</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">File</span><span class="p">;</span>
<span class="n">import</span> <span class="n">java</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">FileInputStream</span><span class="p">;</span>
<span class="n">import</span> <span class="n">java</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">FileNotFoundException</span><span class="p">;</span>
<span class="n">import</span> <span class="n">java</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">FileOutputStream</span><span class="p">;</span>
<span class="n">import</span> <span class="n">java</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">IOException</span><span class="p">;</span>

<span class="n">import</span> <span class="n">com</span><span class="p">.</span><span class="n">qingyuanxingsi</span><span class="p">.</span><span class="n">tutorial</span><span class="p">.</span><span class="n">AddressBookProtos</span><span class="p">.</span><span class="n">AddressBook</span><span class="p">;</span>
<span class="n">import</span> <span class="n">com</span><span class="p">.</span><span class="n">qingyuanxingsi</span><span class="p">.</span><span class="n">tutorial</span><span class="p">.</span><span class="n">AddressBookProtos</span><span class="p">.</span><span class="n">Person</span><span class="p">;</span>
<span class="n">import</span> <span class="n">com</span><span class="p">.</span><span class="n">qingyuanxingsi</span><span class="p">.</span><span class="n">tutorial</span><span class="p">.</span><span class="n">AddressBookProtos</span><span class="p">.</span><span class="n">Person</span><span class="p">.</span><span class="n">PhoneNumber</span><span class="p">;</span>
<span class="n">import</span> <span class="n">com</span><span class="p">.</span><span class="n">qingyuanxingsi</span><span class="p">.</span><span class="n">tutorial</span><span class="p">.</span><span class="n">AddressBookProtos</span><span class="p">.</span><span class="n">Person</span><span class="p">.</span><span class="n">PhoneType</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * A toy example demonstrates the writing and reading process to an address book</span>
<span class="cm"> * proto.</span>
<span class="cm"> * </span>
<span class="cm"> * @author qingyuanxingsi</span>
<span class="cm"> * </span>
<span class="cm"> */</span>
<span class="n">public</span> <span class="n">class</span> <span class="n">AddressBookDemo</span> <span class="p">{</span>
    <span class="n">private</span> <span class="k">static</span> <span class="n">final</span> <span class="n">String</span> <span class="n">FILE_PATH</span> <span class="o">=</span> <span class="s">"addressbook.dat"</span><span class="p">;</span>

    <span class="n">public</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// TODO Auto-generated method stub</span>
        <span class="n">addPerson</span><span class="p">();</span>
        <span class="n">printData</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Print the data out</span>
<span class="cm">     */</span>
    <span class="n">public</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">printData</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// TODO Auto-generated method stub</span>
        <span class="n">try</span> <span class="p">{</span>
            <span class="n">AddressBook</span> <span class="n">addressBook</span> <span class="o">=</span> <span class="n">AddressBook</span>
                    <span class="p">.</span><span class="n">parseFrom</span><span class="p">(</span><span class="n">new</span> <span class="n">FileInputStream</span><span class="p">(</span><span class="n">new</span> <span class="n">File</span><span class="p">(</span><span class="n">FILE_PATH</span><span class="p">)));</span>
            <span class="n">print</span><span class="p">(</span><span class="n">addressBook</span><span class="p">);</span>
        <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">FileNotFoundException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// TODO Auto-generated catch block</span>
            <span class="n">e</span><span class="p">.</span><span class="n">printStackTrace</span><span class="p">();</span>
        <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">IOException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// TODO Auto-generated catch block</span>
            <span class="n">e</span><span class="p">.</span><span class="n">printStackTrace</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Print the whole all data</span>
<span class="cm">     * </span>
<span class="cm">     * @param addressBook</span>
<span class="cm">     */</span>
    <span class="n">public</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">print</span><span class="p">(</span><span class="n">AddressBook</span> <span class="n">addressBook</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// TODO Auto-generated method stub</span>
        <span class="c1">//Iterate over the address book</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">Person</span> <span class="n">person</span> <span class="o">:</span> <span class="n">addressBook</span><span class="p">.</span><span class="n">getPersonList</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">System</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"Person ID: "</span> <span class="o">+</span> <span class="n">person</span><span class="p">.</span><span class="n">getId</span><span class="p">());</span>
            <span class="n">System</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"Person Name: "</span> <span class="o">+</span> <span class="n">person</span><span class="p">.</span><span class="n">getName</span><span class="p">());</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">person</span><span class="p">.</span><span class="n">hasEmail</span><span class="p">())</span> <span class="p">{</span>
                <span class="n">System</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"E-mail address: "</span> <span class="o">+</span> <span class="n">person</span><span class="p">.</span><span class="n">getEmail</span><span class="p">());</span>
            <span class="p">}</span>

            <span class="c1">//Get phone numbers</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">Person</span><span class="p">.</span><span class="n">PhoneNumber</span> <span class="n">phoneNumber</span> <span class="o">:</span> <span class="n">person</span><span class="p">.</span><span class="n">getPhoneList</span><span class="p">())</span> <span class="p">{</span>
                <span class="k">switch</span> <span class="p">(</span><span class="n">phoneNumber</span><span class="p">.</span><span class="n">getType</span><span class="p">())</span> <span class="p">{</span>
                <span class="k">case</span> <span class="n">MOBILE</span>:
                    <span class="n">System</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">"Mobile phone #: "</span><span class="p">);</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="n">HOME</span>:
                    <span class="n">System</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">"Home phone #: "</span><span class="p">);</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="n">WORK</span>:
                    <span class="n">System</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">"Work phone #: "</span><span class="p">);</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">System</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">phoneNumber</span><span class="p">.</span><span class="n">getNumber</span><span class="p">());</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Add a person to the address book file</span>
<span class="cm">     */</span>
    <span class="n">public</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">addPerson</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// TODO Auto-generated method stub</span>
        <span class="n">Person</span> <span class="n">person</span> <span class="o">=</span> <span class="n">Person</span>
                <span class="p">.</span><span class="n">newBuilder</span><span class="p">()</span>
                <span class="p">.</span><span class="n">setId</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="p">.</span><span class="n">setName</span><span class="p">(</span><span class="s">"qingyuanxingsi"</span><span class="p">)</span>
                <span class="p">.</span><span class="n">setEmail</span><span class="p">(</span><span class="s">"demo@server.com"</span><span class="p">)</span>
                <span class="p">.</span><span class="n">addPhone</span><span class="p">(</span>
                        <span class="n">PhoneNumber</span><span class="p">.</span><span class="n">newBuilder</span><span class="p">().</span><span class="n">setNumber</span><span class="p">(</span><span class="s">"13456723421"</span><span class="p">)</span>
                                <span class="p">.</span><span class="n">setType</span><span class="p">(</span><span class="n">PhoneType</span><span class="p">.</span><span class="n">MOBILE</span><span class="p">).</span><span class="n">build</span><span class="p">()).</span><span class="n">build</span><span class="p">();</span>
        <span class="n">AddressBook</span> <span class="n">addressBook</span> <span class="o">=</span> <span class="n">AddressBook</span><span class="p">.</span><span class="n">newBuilder</span><span class="p">().</span><span class="n">addPerson</span><span class="p">(</span><span class="n">person</span><span class="p">)</span>
                <span class="p">.</span><span class="n">build</span><span class="p">();</span>
        <span class="c1">// System.out.println(person);</span>
        <span class="n">FileOutputStream</span> <span class="n">outputStream</span><span class="p">;</span>
        <span class="n">try</span> <span class="p">{</span>
            <span class="n">outputStream</span> <span class="o">=</span> <span class="n">new</span> <span class="n">FileOutputStream</span><span class="p">(</span><span class="n">new</span> <span class="n">File</span><span class="p">(</span><span class="n">FILE_PATH</span><span class="p">));</span>
            <span class="n">addressBook</span><span class="p">.</span><span class="n">writeTo</span><span class="p">(</span><span class="n">outputStream</span><span class="p">);</span>
            <span class="n">outputStream</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
        <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">FileNotFoundException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// TODO Auto-generated catch block</span>
            <span class="n">e</span><span class="p">.</span><span class="n">printStackTrace</span><span class="p">();</span>
        <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">IOException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// TODO Auto-generated catch block</span>
            <span class="n">e</span><span class="p">.</span><span class="n">printStackTrace</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<h3>Apache Avro<sup id="sf-fen-bu-shi-ji-suan-xi-lie-iyarnji-chu-ku-chu-tan-2-back"><a href="#sf-fen-bu-shi-ji-suan-xi-lie-iyarnji-chu-ku-chu-tan-2" class="simple-footnote" title="本部分参考http://avro.apache.org/docs/current/gettingstartedjava.html">2</a></sup></h3>
<p>Apache Avro 是Hadoop 下的一个子项目。它本身既是一个序列化框架,同时也实现了RPC 的功能。Avro官网描述Avro的特性和功能如下:</p>
<ul>
<li>丰富的数据结构类型;</li>
<li>快速可压缩的二进制数据形式;</li>
<li>存储持久数据的文件容器;</li>
<li>提供远程过程调用 RPC;</li>
<li>简单的动态语言结合功能。</li>
</ul>
<p>相比于Apache Thrift和Google Protocol Buffers,Apache Avro具有以下特点:</p>
<ul>
<li>支持动态模式 。Avro 不需要生成代码,这有利于搭建通用的数据处理系统,同时避免了代码入侵。</li>
<li>数据无须加标签 。读取数据前,Avro能够获取模式定义,这使得Avro在数据编码时只需要保留更少的类型信息,有利于减少序列化后的数据大小。</li>
<li>无须手工分配的域标识。Thrift 和 Protocol Buffers使用一个用户添加的整型域唯一性定义一个字段,而Avro则直接使用域名,该方法更加直观、更加易扩展。</li>
</ul>
<p>编写一个 Avro 应用也需如下三步:</p>
<ul>
<li>定义消息格式文件,通常以 avro 作为扩展名;</li>
<li>使用Avro编译器生成特定语言的代码文件(可选);</li>
<li>使用Avro库提供的 API 来编写应用程序。</li>
</ul>
<h2>Reactor Designing Pattern</h2>
<h2>Dive Into Hadoop RPC</h2>
<h1>事件库</h1>
<hr>
<h1>状态机</h1>
<hr><script type="text/javascript">
    if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
        var mathjaxscript = document.createElement('script');
        mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
        mathjaxscript.type = 'text/javascript';
        mathjaxscript.src = 'https:' == document.location.protocol
                ? 'https://c328740.ssl.cf1.rackcdn.com/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'
                : 'http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML';
        mathjaxscript[(window.opera ? "innerHTML" : "text")] =
            "MathJax.Hub.Config({" +
            "    config: ['MMLorHTML.js']," +
            "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } }," +
            "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
            "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
            "    displayAlign: 'center'," +
            "    displayIndent: '0em'," +
            "    showMathMenu: true," +
            "    tex2jax: { " +
            "        inlineMath: [ ['$','$'] ], " +
            "        displayMath: [ ['$$','$$'] ]," +
            "        processEscapes: true," +
            "        preview: 'TeX'," +
            "    }, " +
            "    'HTML-CSS': { " +
            "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'black ! important'} }" +
            "    } " +
            "}); ";
        (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
    }
</script>
<ol class="simple-footnotes"><li id="sf-fen-bu-shi-ji-suan-xi-lie-iyarnji-chu-ku-chu-tan-1">本部分参考https://developers.google.com/protocol-buffers/docs/javatutorial <a href="#sf-fen-bu-shi-ji-suan-xi-lie-iyarnji-chu-ku-chu-tan-1-back" class="simple-footnote-back">↩</a></li><li id="sf-fen-bu-shi-ji-suan-xi-lie-iyarnji-chu-ku-chu-tan-2">本部分参考http://avro.apache.org/docs/current/gettingstartedjava.html <a href="#sf-fen-bu-shi-ji-suan-xi-lie-iyarnji-chu-ku-chu-tan-2-back" class="simple-footnote-back">↩</a></li></ol> 
	<a class="btn btn-mini xsmall" href="../fen-bu-shi-ji-suan-xi-lie-iyarnji-chu-ku-chu-tan.html">
          <i class="icon-comment"></i> Comment </a>
	<hr />
      </div>
      
    </div>
    
<div class="pagination">
<ul>
    <li class="prev disabled"><a href="#">&larr; Previous</a></li>

    <li class="active"><a href="../tag/designing-patterns.html">1</a></li>

    <li class="next disabled"><a href="#">&rarr; Next</a></li>

</ul>
</div>
 
  
        </div>
        
        
    </div>     </div> </div>

<!--footer-->
<div class="container">
  <div class="well" style="background-color: #E9EFF6">
    <div id="blog-footer">
      <div class="row-fluid">
	<div class="social span2" align="center" id="socialist">
	  <ul class="nav nav-list">
	    <li class="nav-header">
	      Social
	    </li>
	    <li><a href="https://github.com/qingyuanxingsi"><i class="icon-Github" style="color: #1f334b"></i>Github</a></li>

	  </ul>
	</div>
        <div class="links span2" align="center">
          <ul class="nav nav-list">
            <li class="nav-header"> 
              Links
            </li>
            
            <li><a href="http://freemind.pluskid.org">Pluskid</a></li>
            <li><a href="https://github.com/julycoding/The-Art-Of-Programming-By-July">结构之法 算法之道</a></li>
            <li><a href="http://www.nosqlnotes.net/">NOSQL Notes</a></li>
          </ul>
        </div>
	<div class="site-nav span2" align="center">
          <ul class="nav nav-list" id="site-links">
            <li class="nav-header"> 
              Site
            </li>
            <li><a href=".."><i class="icon-home" style="color: #1f334b">
                </i>Home</a></li>
            <li><a href="../archives.html"><i class="icon-list" style="color: #1f334b">
                </i>Archives</a></li>
	    <li><a href="../tags.html"><i class="icon-tags" style="color: #1f334b">
                </i>Tags</a></li>
	    
            <li><a href="../" rel="alternate">
                <i class="icon-rss-sign" style="color: #1f334b"></i>
                Atom Feed</a></li>
	  </ul>

        </div>

      </div> <!--end of fluid row-->
    </div> <!--end of blog-footer-->
    <hr />
    <p align="center"><a href="..">Doodle World</a>
      &copy; qingyuanxingsi
    Powered by <a href="github.com/getpelican/pelican">Pelican</a> and
        <a href="https://twitter.github.com/bootstrap">Twitter Bootstrap</a>. 
        Icons by <a href="http://fortawesome.github.com/Font-Awesome">Font Awesome</a> and 
        <a href="http://gregoryloucas.github.com/Font-Awesome-More">Font Awesome More</a></p>

  </div> <!--end of well -->
</div> <!--end of container -->

<!--/footer-->
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
<script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/js/bootstrap.min.js"></script>


<script>var _gaq=[['_setAccount','UA-48582273-1'],['_trackPageview']];(function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.src='//www.google-analytics.com/ga.js';s.parentNode.insertBefore(g,s)}(document,'script'))</script>

</body>
</html>